<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é›†è¨ˆ</title>

    <!-- Chart.jsï¼ˆã‚°ãƒ©ãƒ•æç”»ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ã‚°ãƒ©ãƒ•å†…ã«æ•°å€¤ã‚„ï¼…ã‚’è¡¨ç¤ºã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>

  <body>
    <!-- ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« -->
    <h2 class="title">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é›†è¨ˆçµæœ</h2>

    <!-- ã‚°ãƒ©ãƒ•ï¼‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ã¾ã¨ã‚ãŸã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
      <!-- å††ã‚°ãƒ©ãƒ•è¡¨ç¤ºç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
      <canvas id="reactionChart" width="400" height="400"></canvas>

      <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="ranking" class="ranking"></div>
    </div>

    <h3 class="history-title">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é›†è¨ˆ</h3>

    <table class="history-table">
      <thead>
        <tr id="summary-header">
          <th>ãŠé¡Œ</th>
        </tr>
      </thead>
      <tbody id="summary-body"></tbody>
    </table>

    <script>
      const params = new URLSearchParams(window.location.search);
      /* ===== è¡¨ç¤ºå¯¾è±¡ã®ãƒˆãƒ”ãƒƒã‚¯ ===== */
      const topic = "default";

      /* ===== ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®è‰²å®šç¾© ===== */
      const reactionColors = {
        "ğŸ‘": "#FDCB6E", // é»„è‰²
        "â¤ï¸": "#E74C3C", // èµ¤
        "ğŸ˜‚": "#2ECC71", // ç·‘
        "ğŸ˜¡": "#8E44AD", // ç´«
        "ğŸ™…â€â™€ï¸": "#7489FF", // é’
        "ğŸ˜": "#74B9FF", // æ°´è‰²
      };

      /* ===== ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º ===== */
      async function loadSummary() {
        // APIã‹ã‚‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é›†è¨ˆçµæœã‚’å–å¾—
        const res = await fetch(`/api/reaction/summary?topic=${topic}`);
        const data = await res.json();

        // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        if (data.length === 0) {
          alert("ã¾ã ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“");
          return;
        }

        // çµµæ–‡å­—ã ã‘ã‚’é…åˆ—ã«ã™ã‚‹ï¼ˆãƒ©ãƒ™ãƒ«ç”¨ï¼‰
        const labels = data.map((item) => item.emoji);

        // ä»¶æ•°ã ã‘ã‚’é…åˆ—ã«ã™ã‚‹ï¼ˆã‚°ãƒ©ãƒ•ç”¨ï¼‰
        const counts = data.map((item) => item.count);

        // çµµæ–‡å­—ã«å¯¾å¿œã™ã‚‹è‰²ã‚’å‰²ã‚Šå½“ã¦ã‚‹
        const colors = labels.map(
          (emoji) => reactionColors[emoji] || "#B2BEC3"
        );

        /* ===== å††ã‚°ãƒ©ãƒ•æç”» ===== */
        const ctx = document.getElementById("reactionChart").getContext("2d");

        new Chart(ctx, {
          type: "pie", // å††ã‚°ãƒ©ãƒ•
          data: {
            labels: labels,
            datasets: [
              {
                label: "ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°",
                data: counts,
                backgroundColor: colors,
              },
            ],
          },
          options: {
            responsive: true,
            layout: {
              padding: 20,
            },
            plugins: {
              // å‡¡ä¾‹ï¼ˆä¸‹ã«è¡¨ç¤ºï¼‰
              legend: {
                position: "bottom",
                labels: {
                  font: {
                    size: 14,
                  },
                },
              },
              // å††ã‚°ãƒ©ãƒ•å†…ã«ï¼…ã‚’è¡¨ç¤º
              datalabels: {
                color: (context) =>
                  context.dataset.backgroundColor[context.dataIndex],
                font: {
                  size: 16,
                  weight: "bold",
                },
                formatter: (value, context) => {
                  // åˆè¨ˆæ•°ã‚’è¨ˆç®—
                  const data = context.dataset.data;
                  const total = data.reduce((sum, v) => sum + v, 0);

                  // å‰²åˆï¼ˆï¼…ï¼‰ã‚’è¨ˆç®—
                  const percent = (value / total) * 100;
                  return percent.toFixed(1) + "%";
                },
              },
            },
          },
          plugins: [ChartDataLabels],
        });

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
        renderRanking(data);
        renderCountTable(data);
      }

      /* ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºå‡¦ç† ===== */
      function renderRanking(data) {
        // åˆè¨ˆä»¶æ•°
        const total = data.reduce((sum, item) => sum + item.count, 0);

        // ä»¶æ•°ã®å¤šã„é †ã«ä¸¦ã³æ›¿ãˆ
        const sorted = [...data].sort((a, b) => b.count - a.count);

        const rankingDiv = document.getElementById("ranking");
        rankingDiv.innerHTML = "<h3>ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>";

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’1è¡Œãšã¤ç”Ÿæˆ
        sorted.forEach((item, index) => {
          const percent = ((item.count / total) * 100).toFixed(1);

          const div = document.createElement("div");
          if (index < 3) {
            div.className = `ranking-item podium rank-${index + 1}`;
          } else {
            div.className = "ranking-item";
          }

          const medal =
            index === 0 ? "ğŸ‘‘" : index === 1 ? "ğŸ¥ˆ" : index === 2 ? "ğŸ¥‰" : "";

          div.innerHTML = `
  <span class="rank">
    <span class="rank-icon">${medal}</span>${index + 1}ä½
  </span>
  <span class="emoji">${item.emoji}</span>
  <span class="percent" style="color: ${reactionColors[item.emoji] || "#333"};">
    ${percent}%
  </span>
`;

          rankingDiv.appendChild(div);
        });
      }

      async function loadTopicSummary() {
        const res = await fetch("/api/reaction/summary/all");
        const data = await res.json();

        if (data.length === 0) return;

        // ===== ãŠé¡Œãƒ»ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æŠ½å‡º =====
        const topics = [...new Set(data.map(d => d.topic))];
        const emojis = [...new Set(data.map(d => d.emoji))];

        // ===== ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ¨ªï¼šãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰=====
        const headerRow = document.getElementById("summary-header");
        emojis.forEach(emoji => {
          const th = document.createElement("th");
          th.textContent = emoji;
          headerRow.appendChild(th);
        });

        // ===== topic Ã— emoji â†’ count ã®ãƒãƒƒãƒ— =====
        const map = {};
        data.forEach(d => {
          map[d.topic] ??= {};
          map[d.topic][d.emoji] = d.count;
        });

        // ===== ãƒœãƒ‡ã‚£ï¼ˆç¸¦ï¼šãŠé¡Œï¼‰=====
        const tbody = document.getElementById("summary-body");

        topics.forEach(topic => {
          const tr = document.createElement("tr");

          // ãŠé¡Œã‚»ãƒ«
          const tdTopic = document.createElement("td");
          tdTopic.textContent = topic;
          tr.appendChild(tdTopic);

          // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®ä»¶æ•°
          emojis.forEach(emoji => {
            const td = document.createElement("td");
            td.textContent = map[topic]?.[emoji] ?? 0;
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
      loadSummary();
      loadTopicSummary();

    </script>
  </body>
</html>
