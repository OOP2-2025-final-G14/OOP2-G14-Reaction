<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>„É™„Ç¢„ÇØ„Ç∑„Éß„É≥ÈõÜË®à</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- „Éá„Ç∂„Ç§„É≥ -->
    <style>
      body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        background: #f7f9fc;
        text-align: center;
        margin: 0;
        padding: 40px;
      }

      .title {
        font-size: 28px;
        margin-bottom: 30px;
        color: #333;
      }

      .card {
        background: #fff;
        width: 440px;
        margin: 0 auto;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }

      .ranking{
        margin-top: 30px;
        text-align: left;
      }

      /* „É©„É≥„Ç≠„É≥„Ç∞„ÅÆË¶ãÂá∫„Åó */
      .ranking h3 {
        text-align: center;
        margin-bottom: 15px;
      }

      /* „É©„É≥„Ç≠„É≥„Ç∞1Ë°åÂàÜ */
      .ranking-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-size: 16px;
      }

      .rank {
        width: 40px;
        font-weight: bold;
      }

      .emoji {
        font-size: 22px;
        margin-right: 10px;
      }

      .percent {
        font-weight: bold;
        margin-left: auto;
      }
    </style>
  </head>

  <body>
    <h2 class="title">„É™„Ç¢„ÇØ„Ç∑„Éß„É≥ÈõÜË®àÁµêÊûú</h2>

    <div class="card">
      <canvas id="reactionChart" width="400" height="400"></canvas>

      <!-- „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫ -->
      <div id="ranking" class="ranking"></div>
    </div>

    <script>
      const topic = "default";

      // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥„Åî„Å®„ÅÆËâ≤ÂÆöÁæ©
      const reactionColors = {
        "üëç": "#FDCB6E", // ÈªÑËâ≤
        "‚ù§Ô∏è": "#E74C3C", // Ëµ§
        "üòÇ": "#2ECC71", // Á∑ë
        "üò°": "#F39C12", //ÊøÉ„ÅÑ„Ç™„É¨„É≥„Ç∏
        "üôÖ‚Äç‚ôÄÔ∏è": "#7489FF", // Èùí
        "üòê": "#74B9FF", // Ê∞¥Ëâ≤
      };

      async function loadSummary() {
        const res = await fetch(`/api/reaction/summary?topic=${topic}`);
        const data = await res.json();

        if (data.length === 0) {
          alert("„Åæ„Å†„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
          return;
        }

        const labels = data.map((item) => item.emoji);
        const counts = data.map((item) => item.count);

        // emoji „Å´ÂØæÂøú„Åó„ÅüËâ≤„ÇíÂâ≤„ÇäÂΩì„Å¶
        const colors = labels.map(
          (emoji) => reactionColors[emoji] || "#B2BEC3"
        );
        // ÂÜÜ„Ç∞„É©„Éï
        const ctx = document.getElementById("reactionChart").getContext("2d");

        new Chart(ctx, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [
              {
                label: "„É™„Ç¢„ÇØ„Ç∑„Éß„É≥Êï∞",
                data: counts,
                backgroundColor: colors,
              },
            ],
          },
          options: {
            responsive: true,
            layout: {
              padding: 20,
            },
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  font: {
                    size: 14,
                  },
                },
              },
            },
          },
        });

        //„É©„É≥„Ç≠„É≥„Ç∞
        renderRanking(data);
      }
      function renderRanking(data) {
        //ÂêàË®à‰ª∂Êï∞
        const total = data.reduce((sum, item) => sum + item.count, 0);
        //‰∏¶„Å≥Êõø„Åà
        const sorted = [...data].sort((a, b) => b.count - a.count);

        const rankingDiv = document.getElementById("ranking");
        rankingDiv.innerHTML = "<h3>„É™„Ç¢„ÇØ„Ç∑„Éß„É≥„É©„É≥„Ç≠„É≥„Ç∞</h3>";

        sorted.forEach((item, index) => {
          const percent = ((item.count / total) * 100).toFixed(1);

          const div = document.createElement("div");
          div.className = "ranking-item";

          div.innerHTML = `
            <span class="rank">${index + 1}‰Ωç</span>
            <span class="emoji">${item.emoji}</span>
            <span class="percent" style="color: ${
              reactionColors[item.emoji] || "#333"
            };">
              ${percent}%
            </span>
          `;

          rankingDiv.appendChild(div);
        });
      }

      loadSummary();
    </script>
  </body>
</html>
