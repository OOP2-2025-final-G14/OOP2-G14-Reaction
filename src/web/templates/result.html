<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é›†è¨ˆ</title>

    <!-- Chart.jsï¼ˆã‚°ãƒ©ãƒ•æç”»ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ã‚°ãƒ©ãƒ•å†…ã«æ•°å€¤ã‚„ï¼…ã‚’è¡¨ç¤ºã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <!-- ===== ç”»é¢ãƒ‡ã‚¶ã‚¤ãƒ³ ===== -->
    <style>
      /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        background: #f7f9fc;
        text-align: center;
        margin: 0;
        padding: 40px;
      }

      /* ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .title {
        font-size: 28px;
        margin-bottom: 30px;
        color: #333;
      }

      /* ã‚°ãƒ©ãƒ•ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ã¾ã¨ã‚ã‚‹ã‚«ãƒ¼ãƒ‰ */
      .card {
        background: #fff;
        width: 440px;
        margin: 0 auto;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }

      /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°å…¨ä½“ */
      .ranking {
        margin-top: 30px;
        text-align: left;
      }

      /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¦‹å‡ºã— */
      .ranking h3 {
        text-align: center;
        margin-bottom: 15px;
      }

      /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°1è¡Œåˆ† */
      .ranking-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-size: 16px;
      }

      /* é †ä½è¡¨ç¤º */
      .rank {
        width: 40px;
        font-weight: bold;
      }

      /* çµµæ–‡å­—è¡¨ç¤º */
      .emoji {
        font-size: 22px;
        margin-right: 10px;
      }

      /* ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤º */
      .percent {
        font-weight: bold;
        margin-left: auto;
      }
    </style>
  </head>

  <body>
    <!-- ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« -->
    <h2 class="title">ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é›†è¨ˆçµæœ</h2>

    <!-- ã‚°ãƒ©ãƒ•ï¼‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ã¾ã¨ã‚ãŸã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
      <!-- å††ã‚°ãƒ©ãƒ•è¡¨ç¤ºç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
      <canvas id="reactionChart" width="400" height="400"></canvas>

      <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="ranking" class="ranking"></div>
    </div>

    <script>
      /* ===== è¡¨ç¤ºå¯¾è±¡ã®ãƒˆãƒ”ãƒƒã‚¯ ===== */
      const topic = "default";

      /* ===== ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã®è‰²å®šç¾© ===== */
      const reactionColors = {
        "ğŸ‘": "#FDCB6E", // é»„è‰²
        "â¤ï¸": "#E74C3C", // èµ¤
        "ğŸ˜‚": "#2ECC71", // ç·‘
        "ğŸ˜¡": "#F39C12", // æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸
        "ğŸ™…â€â™€ï¸": "#7489FF", // é’
        "ğŸ˜": "#74B9FF", // æ°´è‰²
      };

      /* ===== ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º ===== */
      async function loadSummary() {
        // APIã‹ã‚‰ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é›†è¨ˆçµæœã‚’å–å¾—
        const res = await fetch(`/api/reaction/summary?topic=${topic}`);
        const data = await res.json();

        // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        if (data.length === 0) {
          alert("ã¾ã ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“");
          return;
        }

        // çµµæ–‡å­—ã ã‘ã‚’é…åˆ—ã«ã™ã‚‹ï¼ˆãƒ©ãƒ™ãƒ«ç”¨ï¼‰
        const labels = data.map((item) => item.emoji);

        // ä»¶æ•°ã ã‘ã‚’é…åˆ—ã«ã™ã‚‹ï¼ˆã‚°ãƒ©ãƒ•ç”¨ï¼‰
        const counts = data.map((item) => item.count);

        // çµµæ–‡å­—ã«å¯¾å¿œã™ã‚‹è‰²ã‚’å‰²ã‚Šå½“ã¦ã‚‹
        const colors = labels.map(
          (emoji) => reactionColors[emoji] || "#B2BEC3"
        );

        /* ===== å††ã‚°ãƒ©ãƒ•æç”» ===== */
        const ctx = document
          .getElementById("reactionChart")
          .getContext("2d");

        new Chart(ctx, {
          type: "pie", // å††ã‚°ãƒ©ãƒ•
          data: {
            labels: labels,
            datasets: [
              {
                label: "ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°",
                data: counts,
                backgroundColor: colors,
              },
            ],
          },
          options: {
            responsive: true,
            layout: {
              padding: 20,
            },
            plugins: {
              // å‡¡ä¾‹ï¼ˆä¸‹ã«è¡¨ç¤ºï¼‰
              legend: {
                position: "bottom",
                labels: {
                  font: {
                    size: 14,
                  },
                },
              },
              // å††ã‚°ãƒ©ãƒ•å†…ã«ï¼…ã‚’è¡¨ç¤º
              datalabels: {
                color: (context) =>
                  context.dataset.backgroundColor[context.dataIndex],
                font: {
                  size: 16,
                  weight: "bold",
                },
                formatter: (value, context) => {
                  // åˆè¨ˆæ•°ã‚’è¨ˆç®—
                  const data = context.dataset.data;
                  const total = data.reduce((sum, v) => sum + v, 0);

                  // å‰²åˆï¼ˆï¼…ï¼‰ã‚’è¨ˆç®—
                  const percent = (value / total) * 100;
                  return percent.toFixed(1) + "%";
                },
              },
            },
          },
          plugins: [ChartDataLabels],
        });

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
        renderRanking(data);
      }

      /* ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºå‡¦ç† ===== */
      function renderRanking(data) {
        // åˆè¨ˆä»¶æ•°
        const total = data.reduce((sum, item) => sum + item.count, 0);

        // ä»¶æ•°ã®å¤šã„é †ã«ä¸¦ã³æ›¿ãˆ
        const sorted = [...data].sort((a, b) => b.count - a.count);

        const rankingDiv = document.getElementById("ranking");
        rankingDiv.innerHTML = "<h3>ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>";

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’1è¡Œãšã¤ç”Ÿæˆ
        sorted.forEach((item, index) => {
          const percent = ((item.count / total) * 100).toFixed(1);

          const div = document.createElement("div");
          div.className = "ranking-item";

          div.innerHTML = `
            <span class="rank">${index + 1}ä½</span>
            <span class="emoji">${item.emoji}</span>
            <span class="percent" style="color: ${
              reactionColors[item.emoji] || "#333"
            };">
              ${percent}%
            </span>
          `;

          rankingDiv.appendChild(div);
        });
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
      loadSummary();
    </script>
  </body>
</html>
